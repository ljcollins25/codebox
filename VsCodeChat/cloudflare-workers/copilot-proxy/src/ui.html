<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Copilot Proxy - Chat</title>
	<style>
		* { box-sizing: border-box; margin: 0; padding: 0; }
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: #0d1117;
			color: #c9d1d9;
			min-height: 100vh;
			display: flex;
			flex-direction: column;
		}
		.container { max-width: 900px; margin: 0 auto; padding: 1rem; flex: 1; display: flex; flex-direction: column; width: 100%; }
		h1 { color: #58a6ff; margin-bottom: 1rem; font-size: 1.5rem; }
		
		/* Auth Section */
		#auth-section {
			background: #161b22;
			border: 1px solid #30363d;
			border-radius: 12px;
			padding: 2rem;
			text-align: center;
			margin-bottom: 1rem;
		}
		#auth-section.hidden { display: none; }
		.code-display {
			font-family: monospace;
			font-size: 2rem;
			font-weight: bold;
			letter-spacing: 0.2em;
			color: #58a6ff;
			background: #0d1117;
			padding: 1rem 2rem;
			border-radius: 8px;
			margin: 1rem 0;
			border: 2px dashed #30363d;
		}
		.btn {
			display: inline-block;
			background: #238636;
			color: white;
			padding: 12px 24px;
			border-radius: 6px;
			text-decoration: none;
			font-weight: 600;
			border: none;
			cursor: pointer;
			margin: 0.5rem;
			font-size: 1rem;
		}
		.btn:hover { background: #2ea043; }
		.btn:disabled { background: #484f58; cursor: not-allowed; }
		.btn-secondary { background: #21262d; border: 1px solid #30363d; }
		.btn-secondary:hover { background: #30363d; }
		.status { margin-top: 1rem; padding: 0.5rem; color: #8b949e; }
		.spinner {
			display: inline-block;
			width: 14px;
			height: 14px;
			border: 2px solid #8b949e;
			border-radius: 50%;
			border-top-color: transparent;
			animation: spin 1s linear infinite;
			margin-right: 8px;
			vertical-align: middle;
		}
		@keyframes spin { to { transform: rotate(360deg); } }
		
		/* Chat Section */
		#chat-section { flex: 1; display: flex; flex-direction: column; position: relative; }
		#chat-section.hidden { display: none; }
		
		.header-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 1rem;
		}
		
		.model-select {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.5rem;
			background: #161b22;
			border-radius: 8px;
		}
		.model-select label { color: #8b949e; }
		.model-select select {
			background: #0d1117;
			color: #c9d1d9;
			border: 1px solid #30363d;
			padding: 0.5rem;
			border-radius: 4px;
		}
		
		.logout-btn {
			background: transparent;
			border: 1px solid #30363d;
			color: #8b949e;
			padding: 0.5rem 1rem;
			border-radius: 4px;
			cursor: pointer;
			font-size: 0.875rem;
		}
		.logout-btn:hover { background: #21262d; }
		
		#messages {
			flex: 1;
			overflow-y: auto;
			padding: 1rem;
			background: #161b22;
			border: 1px solid #30363d;
			border-radius: 12px;
			margin-bottom: 1rem;
			min-height: 300px;
		}
		.message {
			margin-bottom: 1rem;
			padding: 0.75rem 1rem;
			border-radius: 8px;
			max-width: 85%;
			white-space: pre-wrap;
			word-wrap: break-word;
		}
		.message.user {
			background: #238636;
			margin-left: auto;
		}
		.message.assistant {
			background: #21262d;
			border: 1px solid #30363d;
		}
		.message.system {
			background: #1f2937;
			color: #9ca3af;
			font-style: italic;
			max-width: 100%;
			text-align: center;
		}
		.message pre {
			background: #0d1117;
			padding: 0.5rem;
			border-radius: 4px;
			overflow-x: auto;
			margin: 0.5rem 0;
		}
		.message code {
			font-family: 'SF Mono', Monaco, Consolas, monospace;
			font-size: 0.9em;
		}
		
		#input-area {
			display: flex;
			gap: 0.5rem;
		}
		#message-input {
			flex: 1;
			background: #0d1117;
			color: #c9d1d9;
			border: 1px solid #30363d;
			padding: 0.75rem 1rem;
			border-radius: 8px;
			font-size: 1rem;
			resize: none;
			font-family: inherit;
		}
		#message-input:focus { outline: none; border-color: #58a6ff; }
		#send-btn { min-width: 80px; }
		
		.error { color: #f85149; }
		.success { color: #3fb950; }
	</style>
</head>
<body>
	<div class="container">
		<h1>ü§ñ GitHub Copilot Proxy</h1>
		
		<!-- Auth Section -->
		<div id="auth-section">
			<div id="auth-start">
				<p style="margin-bottom: 1rem;">Sign in with GitHub to chat with Copilot models.</p>
				<button class="btn" onclick="startAuth()">Sign in with GitHub</button>
			</div>
			<div id="auth-pending" style="display: none;">
				<p>Enter this code at GitHub:</p>
				<div class="code-display" id="user-code"></div>
				<a id="github-link" href="#" target="_blank" class="btn">Open GitHub ‚Üí</a>
				<div class="status" id="auth-status">
					<span class="spinner"></span>Waiting for authorization...
				</div>
			</div>
		</div>
		
		<!-- Chat Section -->
		<div id="chat-section" class="hidden">
			<div class="header-row">
				<div class="model-select">
					<label for="model">Model:</label>
					<select id="model">
						<option value="gpt-4o">GPT-4o</option>
						<option value="gpt-4.1">GPT-4.1</option>
						<option value="gpt-4.1-mini">GPT-4.1 Mini</option>
						<option value="claude-sonnet-4">Claude Sonnet 4</option>
						<option value="claude-sonnet-4.5">Claude Sonnet 4.5</option>
						<option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
						<option value="o3-mini">O3 Mini</option>
						<option value="o4-mini">O4 Mini</option>
					</select>
				</div>
				<button class="logout-btn" onclick="logout()">Logout</button>
			</div>
			
			<div id="messages"></div>
			
			<div id="input-area">
				<textarea id="message-input" rows="2" placeholder="Type a message... (Shift+Enter for new line)"></textarea>
				<button id="send-btn" class="btn" onclick="sendMessage()">Send</button>
			</div>
		</div>
	</div>
	
	<script>
		let sessionId = localStorage.getItem('copilot_session_id');
		let messages = [];
		let isStreaming = false;
		let pollInterval = null;
		
		// Check if already authenticated
		if (sessionId) {
			showChatSection();
		}
		
		async function startAuth() {
			document.getElementById('auth-start').style.display = 'none';
			document.getElementById('auth-pending').style.display = 'block';
			document.getElementById('auth-status').innerHTML = '<span class="spinner"></span>Starting authentication...';
			
			try {
				const res = await fetch('/start-auth', { method: 'POST' });
				const data = await res.json();
				
				if (data.error) {
					document.getElementById('auth-status').innerHTML = '<span class="error">‚ùå ' + data.error + '</span>';
					return;
				}
				
				sessionId = data.session_id;
				document.getElementById('user-code').textContent = data.user_code;
				document.getElementById('github-link').href = data.verification_uri;
				document.getElementById('auth-status').innerHTML = '<span class="spinner"></span>Waiting for authorization...';
				
				// Start polling
				pollAuth();
				
			} catch (error) {
				document.getElementById('auth-status').innerHTML = '<span class="error">‚ùå ' + error.message + '</span>';
			}
		}
		
		async function pollAuth() {
			const maxAttempts = 60; // 5 minutes with 5s interval
			let attempts = 0;
			
			const poll = async () => {
				attempts++;
				
				try {
					const res = await fetch('/poll-auth', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ session_id: sessionId })
					});
					const data = await res.json();
					
					if (data.status === 'complete') {
						localStorage.setItem('copilot_session_id', sessionId);
						showChatSection();
						return;
					}
					
					if (data.status === 'expired') {
						document.getElementById('auth-status').innerHTML = '<span class="error">‚ùå Session expired. Please try again.</span>';
						return;
					}
					
					if (data.status === 'error') {
						document.getElementById('auth-status').innerHTML = '<span class="error">‚ùå ' + (data.error || 'Unknown error') + '</span>';
						return;
					}
					
					if (attempts < maxAttempts) {
						setTimeout(poll, 5000);
					} else {
						document.getElementById('auth-status').innerHTML = '<span class="error">‚ùå Timed out. Please try again.</span>';
					}
					
				} catch (error) {
					console.error('Poll error:', error);
					if (attempts < maxAttempts) {
						setTimeout(poll, 5000);
					}
				}
			};
			
			poll();
		}
		
		function showChatSection() {
			document.getElementById('auth-section').classList.add('hidden');
			document.getElementById('chat-section').classList.remove('hidden');
			addSystemMessage('Connected to GitHub Copilot. Start chatting!');
			document.getElementById('message-input').focus();
		}
		
		function logout() {
			localStorage.removeItem('copilot_session_id');
			sessionId = null;
			messages = [];
			document.getElementById('messages').innerHTML = '';
			document.getElementById('chat-section').classList.add('hidden');
			document.getElementById('auth-section').classList.remove('hidden');
			document.getElementById('auth-start').style.display = 'block';
			document.getElementById('auth-pending').style.display = 'none';
		}
		
		function addSystemMessage(text) {
			const div = document.createElement('div');
			div.className = 'message system';
			div.textContent = text;
			document.getElementById('messages').appendChild(div);
			scrollToBottom();
		}
		
		function addMessage(role, content) {
			messages.push({ role, content });
			const div = document.createElement('div');
			div.className = 'message ' + role;
			div.textContent = content;
			document.getElementById('messages').appendChild(div);
			scrollToBottom();
			return div;
		}
		
		function scrollToBottom() {
			const container = document.getElementById('messages');
			container.scrollTop = container.scrollHeight;
		}
		
		async function sendMessage() {
			if (isStreaming) return;
			
			const input = document.getElementById('message-input');
			const text = input.value.trim();
			if (!text) return;
			
			input.value = '';
			addMessage('user', text);
			
			const model = document.getElementById('model').value;
			const assistantDiv = addMessage('assistant', '');
			
			isStreaming = true;
			document.getElementById('send-btn').disabled = true;
			
			try {
				const chatMessages = messages.slice(0, -1).map(m => ({
					role: m.role === 'assistant' ? 'assistant' : 'user',
					content: m.content
				}));
				chatMessages.push({ role: 'user', content: text });
				
				const res = await fetch('/chat', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						session_id: sessionId,
						model: model,
						messages: chatMessages
					})
				});
				
				if (!res.ok) {
					const error = await res.json();
					assistantDiv.textContent = '‚ùå ' + (error.error || 'Request failed');
					assistantDiv.classList.add('error');
					messages.pop();
					return;
				}
				
				const reader = res.body.getReader();
				const decoder = new TextDecoder();
				let buffer = '';
				let fullContent = '';
				
				while (true) {
					const { done, value } = await reader.read();
					if (done) break;
					
					buffer += decoder.decode(value, { stream: true });
					const lines = buffer.split('\n');
					buffer = lines.pop() || '';
					
					for (const line of lines) {
						if (!line.startsWith('data: ')) continue;
						const data = line.slice(6);
						if (data === '[DONE]') continue;
						
						try {
							const chunk = JSON.parse(data);
							const content = chunk.choices?.[0]?.delta?.content;
							if (content) {
								fullContent += content;
								assistantDiv.textContent = fullContent;
								scrollToBottom();
							}
						} catch (e) {
							// Ignore parse errors
						}
					}
				}
				
				// Update the stored message with full content
				if (fullContent) {
					messages[messages.length - 1].content = fullContent;
				} else {
					messages.pop();
					assistantDiv.textContent = '‚ùå No response received';
					assistantDiv.classList.add('error');
				}
				
			} catch (error) {
				assistantDiv.textContent = '‚ùå ' + error.message;
				assistantDiv.classList.add('error');
				messages.pop();
			} finally {
				isStreaming = false;
				document.getElementById('send-btn').disabled = false;
				document.getElementById('message-input').focus();
			}
		}
		
		// Handle Enter key
		document.getElementById('message-input').addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		});
	</script>
</body>
</html>
