ss_token&&!this.isTokenExpiring()){t.token_type=t.token_type||"Bearer";let c={Authorization:t.token_type+" "+t.access_token};return{headers:this.addSharedMetadataHeaders(c)}}if(this.refreshHandler){let c=await this.processAndValidateRefreshHandler();if(c?.access_token){this.setCredentials(c);let l={Authorization:"Bearer "+this.credentials.access_token};return{headers:this.addSharedMetadataHeaders(l)}}}if(this.apiKey)return{headers:{"X-Goog-Api-Key":this.apiKey}};let r=null,a=null;try{r=await this.refreshToken(t.refresh_token),a=r.tokens}catch(c){let l=c;throw l.response&&(l.response.status===403||l.response.status===404)&&(l.message=`Could not refresh access token: ${l.message}`),l}let o=this.credentials;o.token_type=o.token_type||"Bearer",a.refresh_token=o.refresh_token,this.credentials=a;let s={Authorization:o.token_type+" "+a.access_token};return{headers:this.addSharedMetadataHeaders(s),res:r.res}}static getRevokeTokenUrl(e){return new n().getRevokeTokenURL(e).toString()}getRevokeTokenURL(e){let t=new URL(this.endpoints.oauth2RevokeUrl);return t.searchParams.append("token",e),t}revokeToken(e,t){let r={...n.RETRY_CONFIG,url:this.getRevokeTokenURL(e).toString(),method:"POST"};if(t)this.transporter.request(r).then(a=>t(null,a),t);else return this.transporter.request(r)}revokeCredentials(e){if(e)this.revokeCredentialsAsync().then(t=>e(null,t),e);else return this.revokeCredentialsAsync()}async revokeCredentialsAsync(){let e=this.credentials.access_token;if(this.credentials={},e
