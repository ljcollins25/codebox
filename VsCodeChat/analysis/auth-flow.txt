async authFromGitHubToken(t,r){return this.doAuthFromGitHubTokenOrDevDeviceId({githubToken:t,ghUsername:r})}async authFromDevDeviceId(t){return this.doAuthFromGitHubTokenOrDevDeviceId({devDeviceId:t})}async doAuthFromGitHubTokenOrDevDeviceId(t){this._telemetryService.sendGHTelemetryEvent("auth.new_login");let r,a,o;if("githubToken"in t?(o=t.ghUsername,[r,a]=await Promise.all([this.fetchCopilotTokenFromGitHubToken(t.githubToken),this.fetchCopilotUserInfo(t.githubToken)])):r=await this.fetchCopilotTokenFromDevDeviceId(t.devDeviceId),!r)return this._logService.warn("Failed to get copilot token"),this._telemetryService.sendGHTelemetryErrorEvent("auth.request_failed"),{kind:"failure",reason:"RequestFailed"};let s=await pDt(r);if(!s)return this._logService.warn("Failed to get copilot token"),this._telemetryService.sendGHTelemetryErrorEvent("auth.request_read_failed"),{kind:"failure",reason:"ParseFailed"};if(r.status===401)return this._logService.warn("Failed to get copilot token due to 401 status"),this._telemetryService.sendGHTelemetryErrorEvent("auth.unknown_401"),{kind:"failure",reason:"HTTP401"};if(r.status===403&&s.message?.startsWith("API rate limit exceeded"))return this._logService.warn("Failed to get copilot token due to exceeding API rate limit"),this._telemetryService.sendGHTelemetryErrorEvent("auth.rate_limited"),{kind:"failure",reason:"RateLimited"};if(!r.ok||!s.token){this._logService.warn(`Invalid copilot token: missing token: ${r.status} ${r.statusText}`);let m=ws.createAndMarkAsIssued({status:r.status.toString(),status_text:r.statusText});return this._telemetryService.sendGHTelemetryErrorEvent("auth.invalid_token",m.properties,m.measurements),{kind:"failure",reason:"NotAuthorized",...s.error_details}}let c=s.expires_at;s.expires_at=_F()+s.refresh_in+60;let l=o??"unknown",d=!1;rXe(s.organization_list??[])&&"githubToken"in t&&(d=!!await this._baseOctokitservice.getTeamMembershipWithToken(aDt,t.githubToken,l));let u={...s,copilot_plan:a?.copilot_plan??s.sku??"",quota_snapshots:a?.quota_snapshots,quota_reset_date:a?.quota_reset_date,codex_agent_enabled:a?.codex_agent_enabled,username:l,isVscodeTeamMember:d},p=ws.createAndMarkAsIssued({},{adjusted_expires_at:s.expires_at,expires_at:c,current_time:_F()});return this._telemetryService.sendGHTelemetryEvent("auth.new_token",p.properties,p.measurements),{kind:"success",...u}}async fetchCopilotTokenFromGitHubToken(t){let r={headers:{Authorization:`token ${t}`,"X-GitHub-Api-Version":"2025-04-01"},retryFallbacks:!0,expectJSON:!0};return await this._capiClientService.makeRequest(r,{type:zn.CopilotToken})}async fetchCopilotTokenFromDevDeviceId(t){let r={headers:{"X-GitHub-Api-Version":"2025-04-01","Editor-Device-Id":`${t}`},retryFallbacks:!0,expectJSON:!0};return await this._capiClientService.makeRequest(r,{type:zn.CopilotNLToken})}async fetchCopilotUserInfo(t){let r={headers:{Authorization:`token ${t}`,"X-GitHub-Api-Version":"2025-04-01"},retryFallbacks:!0,expectJSON:!0};return await(await this._capiClientService.makeRequest(r,{type:zn.CopilotUserInfo})).json()}},vce=class extends y3{constructor(t,r,a,o,s,c,l){super(new QT(o,c,r,a),r,a,s,o,c,l);this._completionsToken=t;this.copilotToken={token:t,expires_at:0,refresh_in:0,username:"fixedTokenManager",isVscodeTeamMember:!1,copilot_plan:"unknown"}}set completionsToken(t){this._completionsToken=t,this.copilotToken={token:t,expires_at:0,refresh_in:0,username:"fixedTokenManager",isVscodeTeamMember:!1,copilot_plan:"unknown"}}get completionsToken(){return this._completionsToken}async getCopilotToken(){return new PT(this.copilotToken)}async checkCopilotToken(){return{status:"OK"}}};vce=I([h(1,ne),h(2,Te),h(3,Qn),h(4,Qo),h(5,cn),h(6,Rt)],vce);var Cce=class extends y3{constructor(e,t,r,a,o,s,c){super(new QT(a,s,t,r),t,r,o,a,s,c);let l=Buffer.from(e,"base64").toString("utf8");this._initialToken=JSON.parse(l)}async getCopilotToken(){return this.copilotToken||(this.copilotToken={...this._initialToken}),new PT(this._initialToken)}async checkCopilotToken(){return{status:"OK"}}};Cce=I([h(1,ne),h(2,Te),h(3,Qn),h(4,Qo),h(5,cn),h(6,Rt)],Cce);var r1e=class extends y3{async getCopilotToken(e){if(!this.copilotToken||this.copilotToken.expires_at<_F()-60*5||e){let t=await this.authenticateAndGetToken();if(t.kind==="failure")throw Error(`Failed to get copilot token: ${t.reason.toString()} ${t.message??""}`);this.copilotToken={...t}}return new PT(this.copilotToken)}async checkCopilotToken(){if(!this.copilotToken||this.copilotToken.expires_at<_F()){let t=await this.authenticateAndGetToken();if(t.kind==="failure")return t;this.copilotToken={...t}}return{status:"OK"}}},wce=class extends r1e{constructor(t,r,a,o,s,c,l,d){super(new QT(s,c,r,a),r,a,o,s,c,l);this.deviceId=t;this.configurationService=d}async authenticateAndGetToken(){return this.authFromDevDeviceId(this.deviceId)}};wce=I([h(1,ne),h(2,Te),h(3,Qo),h(4,Qn),h(5,cn),h(6,Rt),h(7,Ce)],wce);var Ece=class extends r1e{constructor(t,r,a,o,s,c,l,d,u){super(new QT(c,l,a,o),a,o,s,c,l,d);this.
